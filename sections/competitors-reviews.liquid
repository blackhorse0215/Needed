<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<section class="competitors-reviews">
  <div class="reviews-inner container">
    <div class="reviews-content">
      <div class="reviews-descr">{{ section.settings.description }}</div>
      <div class="reviews-form">
        <div class="klaviyo-form-URDhk9"></div>

        <div class="reviews-form-inner">
          <select class="select brand-list">
            <option value=""></option>
            {% for block in section.blocks %}
              <option value="{{ block.settings.title }}">{{ block.settings.title }}</option>
            {% endfor %}
          </select>

          <div class="prenatal-input-label">Select from the autocomplete list or type in the one you use.</div>
          <input type="email" class="input email" placeholder="Your email" required>
          <button type="submit" class="button button--primary download-guide">
            download the prenatal vitamin review guide!
          </button>
        </div>

        <script>
          var new_urdhk9_brand = '';

          $('.competitors-reviews .reviews-form-inner .download-guide').click(function(e) {
            let selected_brand = $('.competitors-reviews .reviews-form-inner .brand-list').val();
            let email = $('.competitors-reviews .reviews-form-inner .email').val();

            if (email == '') {
              alert('Please input your email!');
              return false;
            }
            if (selected_brand == '') {
              alert('Please select or enter the brand you use!');
              return false;
            }
            console.log('download');
            const downloadFile = (file) => {
                const element = document.createElement('a');
                element.setAttribute('href', '{{ "Needed_Prenatal-Vitamin-Reviews.pdf" | asset_url }}');
                element.setAttribute('download', '');
                element.setAttribute('target', '_blank');

                element.style.display = 'none';

                document.body.appendChild(element);

                element.click();
                document.body.removeChild(element);
            }

            downloadFile("{{ 'Needed_Prenatal-Vitamin-Reviews.pdf' | asset_url }}");

            var klaviyoForm = $(".competitors-reviews .klaviyo-form-URDhk9 form");

            klaviyoForm.find('input[aria-label="Your email"]').focus().val(email).blur();
            klaviyoForm.find('input[aria-label="New prenatal"]').focus().val(new_urdhk9_brand).blur();
            klaviyoForm.find('input[aria-label="What prenatal are you currently taking?"]').focus().val(selected_brand).blur();

            setTimeout(() => {
              klaviyoForm.find('button.go332817621.kl-private-reset-css-Xuajs1').trigger("click");
            }, 500);
          });
          
          $('.competitors-reviews .reviews-form-inner input.email').keypress(function(e) {
            if (e.keyCode == 13) {
              $('.competitors-reviews .reviews-form-inner .download-guide').click();
            }
          });

          $('.competitors-reviews .reviews-form-inner .brand-list').select2({
            placeholder: 'What prenatal are you currently taking?',
            allowClear: true,
            tags: true,
            createTag: function (params) {
              var term = $.trim(params.term);

              if (term === '') {
                return null;
              }

              return {
                id: term,
                text: term,
                isNew: true
              }
            }
          }).on("select2:select", function(e) {
            if(e.params.data.isNew){
              new_urdhk9_brand = e.params.data.text;
            }
          });

          window.addEventListener("klaviyoForms", function(e) { 
            if (e.detail.type == 'embedOpen') {
              $('.competitors-reviews .reviews-form-inner').css('opacity', '1');
              $('.competitors-reviews .reviews-form-inner').css('height', '100%');
            }
            if (e.detail.type == 'submit') {
              console.log('submit download');
              const downloadFile = (file) => {
                const element = document.createElement('a');
                element.setAttribute('href', '{{ "Needed_Prenatal-Vitamin-Reviews.pdf" | asset_url }}');
                element.setAttribute('download', '');
                element.setAttribute('target', '_blank');

                element.style.display = 'none';

                document.body.appendChild(element);

                element.click();
                document.body.removeChild(element);
              }

              downloadFile("{{ 'Needed_Prenatal-Vitamin-Reviews.pdf' | asset_url }}");

              $('.competitors-reviews .reviews-form-inner').html('<div class="success-note"><i class="fa fa-check"></i>Thank you. Your download is active in another browser tab.</div>')
            }
          });
        </script>
      </div>
      <div class="reviews-info">
        <div class="info-text">{{ section.settings.info_text }}</div>
      </div>
    </div>

    <div class="reviews-image">
      <img class="lazyload" data-src="{{ section.settings.image | img_url: 'master' }}" alt="{{ section.settings.image.alt | escape }}">
    </div>
  </div>
</section>

<style>
  .klaviyo-form-URDhk9 {
    opacity: 0;
    height: 0;
    overflow: hidden;
  }
  .klaviyo-form-URDhk9 button {
    padding: 0 !important;
  }
  .klaviyo-form-URDhk9 .DropdownComponents__DropdownField-sc-1mxqjnw-2 {
    border-radius: 30px !important;
  }
  .klaviyo-form-URDhk9 .DropdownComponents__DropdownField-sc-1mxqjnw-2 input:focus {
    border: none !important;
    box-shadow: unset !important;
  }
  .klaviyo-form-URDhk9 .DropdownComponents__DropdownField-sc-1mxqjnw-2:focus-within {
    border: none !important;
    box-shadow: unset !important;
  }
  .klaviyo-form-URDhk9 .TextInput__FormStyledTextInput-j8u27t-0 {
    border-radius: 30px !important;
  }
  .klaviyo-form-URDhk9 .TextInput__FormStyledTextInput-j8u27t-0:focus {
    border: none !important;
    box-shadow: unset !important;
  }
</style>

{% schema %}
  {
    "name": "Reviews",
    "settings": [
      {
        "type": "richtext",
        "id": "description",
        "label": "Description"
      },
      {
        "type": "textarea",
        "id": "info_text",
        "label": "Information Text"
      },
      {
        "type": "image_picker",
        "id": "image",
        "label": "Image"
      }
    ],
    "blocks": [
      {
        "name": "Brand",
        "type": "brand",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Title"
          }
        ]
      }
    ]
  }
{% endschema %}